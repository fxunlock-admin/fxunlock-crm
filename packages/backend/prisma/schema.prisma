// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  AFFILIATE
  BROKER
  ADMIN
}

enum UserStatus {
  PENDING
  VERIFIED
  SUSPENDED
  REJECTED
}

enum DealStatus {
  OPEN
  IN_NEGOTIATION
  ACCEPTED
  CLOSED
  CANCELLED
}

enum DealType {
  CPA
  REBATES
  HYBRID
  PNL
}

enum BidStatus {
  PENDING
  COUNTERED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  role      UserRole
  status    UserStatus @default(PENDING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  profile       Profile?
  brokerProfile BrokerProfile?
  dealRequests  DealRequest[]
  bids          Bid[]
  sentMessages  Message[]      @relation("SentMessages")
  auditLogs     AuditLog[]
  connectionsAsAffiliate Connection[] @relation("AffiliateConnections")
  connectionsAsBroker    Connection[] @relation("BrokerConnections")

  @@index([email])
  @@index([role])
  @@index([status])
}

model Profile {
  id          String   @id @default(cuid())
  userId      String   @unique
  companyName String?
  firstName   String?
  lastName    String?
  phone       String?
  country     String?
  website     String?
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BrokerProfile {
  id                    String             @id @default(cuid())
  userId                String             @unique
  companyName           String?
  website               String?
  regulatedBy           String?
  yearsInBusiness       Int?
  dealsAccepted         String[]           @default([])
  regulatoryLicense     String?
  minTradeVolume        Float?
  maxTradeVolume        Float?
  preferredRegions      String[]
  preferredInstruments  String[]
  subscriptionStatus    SubscriptionStatus @default(INACTIVE)
  stripeCustomerId      String?            @unique
  stripeSubscriptionId  String?            @unique
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([subscriptionStatus])
  @@index([stripeCustomerId])
}

model DealRequest {
  id                String     @id @default(cuid())
  affiliateId       String
  title             String
  description       String     @db.Text
  dealType          DealType   @default(REBATES)
  
  // Legacy fields (kept for backward compatibility)
  targetCommission  Float?
  targetSpread      Float?
  expectedVolume    Float?
  
  // CPA specific fields
  ftdsPerMonth      Int?
  cpaTiers          Json?      // Array of {tierName, depositAmount, cpaAmount}
  expectedRoi       Float?
  lotsToQualifyCpa  Float?     // Minimum lots required to qualify for CPA
  
  // Rebate specific fields
  netDepositsPerMonth Float?
  expectedVolumeInLots Float?
  rebatePerLot      Float?
  
  // PnL specific fields
  pnlPercentage     Float?
  
  // Common fields
  region            String
  instruments       String[]
  proofOfStatsUrl   String?
  additionalTerms   String?    @db.Text
  status            DealStatus @default(OPEN)
  expiresAt         DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  affiliate    User          @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  bids         Bid[]
  negotiations Negotiation[]
  connections  Connection[]

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
}

model Bid {
  id               String    @id @default(cuid())
  dealRequestId    String
  brokerId         String
  
  // CPA specific fields
  offeredCpaTiers           Json?
  offeredLotsToQualifyCpa   Float?
  
  // Rebate specific fields
  offeredRebatePerLot       Float?
  
  // PnL specific fields
  offeredPnlPercentage      Float?
  
  // Legacy fields (for backward compatibility)
  offeredCommission Float?
  offeredSpread    Float?
  
  message          String?   @db.Text
  status           BidStatus @default(PENDING)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  dealRequest  DealRequest   @relation(fields: [dealRequestId], references: [id], onDelete: Cascade)
  broker       User          @relation(fields: [brokerId], references: [id], onDelete: Cascade)
  negotiations Negotiation[]

  @@index([dealRequestId])
  @@index([brokerId])
  @@index([status])
  @@index([createdAt])
}

model Negotiation {
  id            String   @id @default(cuid())
  dealRequestId String
  bidId         String
  counterOffer  Json
  message       String?  @db.Text
  fromAffiliate Boolean
  createdAt     DateTime @default(now())

  dealRequest DealRequest @relation(fields: [dealRequestId], references: [id], onDelete: Cascade)
  bid         Bid         @relation(fields: [bidId], references: [id], onDelete: Cascade)

  @@index([dealRequestId])
  @@index([bidId])
  @@index([createdAt])
}

model Connection {
  id            String   @id @default(cuid())
  dealRequestId String
  affiliateId   String
  brokerId      String
  finalTerms    Json
  createdAt     DateTime @default(now())

  dealRequest DealRequest @relation(fields: [dealRequestId], references: [id], onDelete: Cascade)
  affiliate   User        @relation("AffiliateConnections", fields: [affiliateId], references: [id], onDelete: Cascade)
  broker      User        @relation("BrokerConnections", fields: [brokerId], references: [id], onDelete: Cascade)
  messages    Message[]

  @@index([dealRequestId])
  @@index([affiliateId])
  @@index([brokerId])
  @@index([createdAt])
}

model Message {
  id           String   @id @default(cuid())
  connectionId String
  senderId     String
  content      String   @db.Text
  isRead       Boolean  @default(false)
  createdAt    DateTime @default(now())

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  sender     User       @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([senderId])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}
